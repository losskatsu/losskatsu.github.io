---
title: "[Infra] 쿠버네티스(kubernetes)(3) 쿠버네티스로 서비스 배포하기" 
categories:
  - it-infra
tags:
  - it-infra
use_math: true
toc: true
toc_label: "My Table of Contents"
toc_icon: "cog"
sidebar:
  title: "AI Machine Learning"
  nav: sidebar-contents
---

# 쿠버네티스로 서비스 배포하기(작성중)

**참고 링크**

* [(0)도커의 개념](https://losskatsu.github.io/it-infra/docker00/)  
* [(1)도커 설치하기, hello world!](https://losskatsu.github.io/it-infra/docker01/)  
* [(2)도커 컨테이너 조작 기초(pull, run, ps)](https://losskatsu.github.io/it-infra/docker02/)  
* [(3)도커 이미지 변경 후 저장(commit)](https://losskatsu.github.io/it-infra/docker03/)  
* [(4)도커 컨테이너 네트워크](https://losskatsu.github.io/it-infra/docker04/)  
* [(5)도커 API 이미지 빌드 및 컨테이너 실행](https://losskatsu.github.io/it-infra/docker05/)
* [(6)도커 컴포즈를 활용한 여러 개의 Flask, Nginx 배포](https://losskatsu.github.io/it-infra/docker06/)
* [(1)쿠버네티스 구조](https://losskatsu.github.io/it-infra/kubernetes01/)  
* [(2)쿠버네티스 설치](https://losskatsu.github.io/it-infra/kubernetes02/)


## 쿠버네티스 기초

쿠버네티스는 sudo 권한으로 실행해야합니다. 
사용자 권한으로 kubectl 같은 명령어 내리면 안되요.
따라서 코드를 치기전에 반드시 다음 커맨드를 입력해 sudo 로 전환합시다. 

```bash
# sudo -i
```

### 파드(pod)란?

파드(pod)란 쿠버네티스에서 컨테이너를 실행하는 최소 단위입니다. 
하나의 파드에는 컨테이너가 포함되어 있는데, 
이 때, 하나의 파드에는 컨테이너 하나가 포함될 수도 있고, 
여러 개의 컨테이너가 포함될 수도 있습니다.
그리고 하나의 파드에 속하는 컨테이너들은 같은 노드에서 동작합니다. 
즉, 동일한 파드에 속해 있는 컨테이너들이 서로 다른 노드에 흩어진 상태로 동작할수는 없다는 뜻입니다. 
(하나의 노드에 뭉쳐있어야함)

또한 파드 내부의 컨테이너들은 파드의 IP 주소와 포트번호를 공유합니다. 
그리고 파드 내부 컨테이너들은 localhost로 서로 통신할 수 있으며, 
파드의 볼륨을 마운트하여 파일 시스템을 공유할 수 있습니다.

파드 IP는 기동시 부여되고 종료시 회수되어 다른 파드가 사용할 수 있습니다. 
즉, 파드는 실행할 때마다 IP가 변경되므로 파드에 요청을 보내고 싶을 떄는 반드시 서비스(service)를 사용해야합니다.  

파드는 하나의 가상 서버 처럼 동작합니다.  

파드는 단독으로 사용되기 보다는 서비스, 컨트롤러, 컨피그맵, 퍼시스턴트 볼륨, 시크릿 등의 오브젝트와 함께 사용됩니다.


### 쿠버네티스 클러스터 정보

다음 커맨드를 입력해 쿠버네티스가 돌아가는 클러스터 정보를 확인합시다. 

```bash
# kubectl cluster-info
Kubernetes control plane is running at https://10.1.55.220:6443
CoreDNS is running at https://10.1.55.220:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

위 정보를 보면 클러스터 정보가 나타납니다.

### 쿠버네티스 노드 확인

다음 커맨드를 입력하면 쿠버네티스 노드를 확인할 수 있습니다. 

```bash
# kubectl get node
NAME    STATUS   ROLES                  AGE   VERSION
brain   Ready    control-plane,master   21d   v1.23.4
```

결과를 보면 노드가 하나인 것을 알 수 있습니다. 
저는 서버가 한 대밖에 없어서 노드가 하나 입니다. 


### 파드, 서비스 확인

파드(pod) 확인은 다음과 같이 입럭합니다. 
아래 결과에서 아무 결과가 안나오는 것은 현재 운영중인 파드가 없기 때문입니다. 

```bash
# kubectl get pod
No resources found in default namespace.
```

서비스(service) 확인은 다음과 같이 입력합니다. 

```bash
# kubectl get service
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   21d
```

## 배포할 때 필요한 것

(이 파일은 현재 작성중입니다.)

도커 이미지 파일이 필요합니다. 
지금까지 찾아본 바로는 쿠버네티스 yaml 파일로 이미지 빌드까지는 안되는거 같고
도커로 이미지를 빌드해서 이미지가 준비된 상태에서 쿠버네티스로 배포만 합니다. 


yaml('야믈'이라고 읽음) 파일 작성

deployment.yml
service.yml

## YAML 파일 작성하기

```
deployment.yaml
```
```bash
 apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: web-deploy
  spec:
    replicas: 3
    selector:
      matchLabels:
        app: web
    template:
      metadata:
        labels:
          app: web
      spec:
        containers:
          - name: nginx-lipaco
            image: living_paradise_nginx
            ports:
              - containerPort: 8004
          - name: flask-lipaco
            image: living_paradise_predict_product_demand
            ports:
              - containerPort: 5004

```



```
serivce.yml
```
```bash
apiVersion: v1
kind: Service
metadata:
  name: web-service
spec:
  type: LoadBalancer
  selector:
    app: web
  ports:
    - protocol: TCP
      port: 8004

```

yaml 파일 작성할 때 주의해야할 점은 들여쓰기 할때, tab 쓰면 안되고 space 써야합니다. 

## 배포

```bash
$ sudo -i
# kubectl apply -f deployment.yml
# kubectl apply -f service.yml
```

## 삭제

```bash
# kubectl delete pod web-deploy
# kubectl delete service web-service
```


